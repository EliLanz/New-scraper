name: Daily News Scraper

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ—©ä¸Š 7:00 åŒ—äº¬æ—¶é—´è¿è¡Œï¼ˆUTC 23:00ï¼‰
  schedule:
    - cron: '0 23 * * *'  # UTC æ—¶é—´ 23:00ï¼Œå³åŒ—äº¬æ—¶é—´ 7:00
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # Push åˆ° main åˆ†æ”¯æ—¶ä¹Ÿè¿è¡Œï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/**.yml'

# çŽ¯å¢ƒå˜é‡ï¼ˆå…¬å…±é…ç½®ï¼‰
env:
  PYTHON_VERSION: '3.9'

jobs:
  scrape-and-send:
    name: æŠ“å–æ–°é—»å¹¶å‘é€é‚®ä»¶
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: ðŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. åˆ›å»ºé…ç½®æ–‡ä»¶ï¼ˆä»Ž GitHub Secrets è¯»å–ï¼‰
      - name: âš™ï¸ é…ç½®çŽ¯å¢ƒ
        run: |
          # åˆ›å»ºé‚®ä»¶é…ç½®æ–‡ä»¶
          cat > email_config.json << EOF
          {
            "sender_email": "${{ secrets.SENDER_EMAIL }}",
            "sender_password": "${{ secrets.SENDER_PASSWORD }}",
            "recipients": ${{ secrets.RECIPIENTS }},
            "smtp_type": "${{ secrets.SMTP_TYPE }}"
          }
          EOF
          
          # åˆ›å»ºè¾“å‡ºç›®å½•å’Œæ—¥å¿—ç›®å½•
          mkdir -p output logs
          
          echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º"
      
      # 5. è¿è¡Œæ–°é—»æŠ“å–
      - name: ðŸ“° æŠ“å–æ–°é—»
        run: |
          echo "å¼€å§‹æŠ“å–æ–°é—»..."
          python news_scraper_hybrid.py
        continue-on-error: false
      
      # 6. å‘é€é‚®ä»¶
      - name: ðŸ“§ å‘é€é‚®ä»¶
        run: |
          echo "å‡†å¤‡å‘é€é‚®ä»¶..."
          python daily_news_task.py
        continue-on-error: true
      
      # 7. ä¸Šä¼ ç”Ÿæˆçš„æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
      - name: ðŸ“¤ ä¸Šä¼ æ–°é—»æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: news-report
          path: output/
          retention-days: 30
      
      # 8. ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      - name: ðŸ“‹ ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: logs/
          retention-days: 7
      
      # 9. æ˜¾ç¤ºæ‰§è¡Œç»“æžœ
      - name: âœ… æ‰§è¡Œå®Œæˆ
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… æ–°é—»æŠ“å–å’Œé‚®ä»¶å‘é€å®Œæˆï¼"
          echo "=========================================="
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ç”Ÿæˆçš„æŠ¥å‘Š:"
          ls -lh output/*.md 2>/dev/null | tail -5 || echo "æš‚æ— æŠ¥å‘Šæ–‡ä»¶"
      
      # 10. é”™è¯¯å¤„ç†
      - name: âŒ æ‰§è¡Œå¤±è´¥
        if: failure()
        run: |
          echo "=========================================="
          echo "âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          echo "=========================================="
          echo "è¯·æŸ¥çœ‹æ—¥å¿—ä»¥èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          if [ -f logs/*.log ]; then
            echo "æœ€æ–°æ—¥å¿—:"
            tail -20 logs/*.log 2>/dev/null || echo "æš‚æ— æ—¥å¿—æ–‡ä»¶"
          fi
